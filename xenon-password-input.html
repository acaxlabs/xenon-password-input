<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html" />
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html" />
<link rel="import" href="../iron-input/iron-input.html" />
<link rel="import" href="../paper-input/paper-input-container.html" />
<link rel="import" href="../paper-input/paper-input-error.html" />
<!--
    
The component will handle  password validation. Passwords must be 8 characters long and not 
be contained in the blacklist.

        `<xenon-password-input label="Password" value="{{pw}}"></xenon-password-input>`

    @group Xenon Elements
    @element xenon-password-input
    @demo demo/index.html
-->
<dom-module id="xenon-password-input">
    <template>
        <iron-ajax auto handle-as="text" url="blacklist.txt" on-response="onBlacklist"></iron-ajax>
        <paper-input-container id="container" invalid="{{invalid}}">
            <label hidden$="[[!label]]">[[label]]</label>
            <div class="horizontal layout">
                <input is="iron-input"
                       id="input"
                       class="flex"
                       aria-labelledby$="[[_ariaLabelledBy]]"
                       aria-describedby$="[[_ariaDescribedBy]]"
                       required
                       bind-value="{{value}}"
                       name$="[[name]]"
                       disabled$="[[disabled]]"
                       invalid="{{invalid}}"
                       autofocus$="[[autofocus]]"
                       inputmode$="[[inputmode]]"
                       placeholder$="[[placeholder]]"
                       readonly$="[[readonly]]"
                       pattern$="[[pattern]]"
                       maxlength$="[[length]]"
                       prevent-invalid-input="[[preventInvalidInput]]"
                       allowed-pattern="[[allowedPattern]]"
                       type="password">
            </div>
            <template is="dom-if" if="[[errorMessage]]">
                <paper-input-error id="error">[[errorMessage]]</paper-input-error>
            </template>
        </paper-input-container>
    </template>
    <script>
        
        Polymer({
            is: "xenon-password-input",
            properties: {
                username: { type: String, notify: true, value: "" },
                blacklist: Array, 
                /* string value */
                value: { type: String, notify: true },
                errorMessage: { type: String, notify: true, value: "Password is invalid." }
            },
            behaviors: [
              Polymer.IronFormElementBehavior
            ], 
            onBlacklist: function (e) {
                this.blacklist = e.detail.response.replace(/(?:\r\n|\r|\n)/g, "|").split("|");
            },
            /* Does the password validation checking */
            validate: function () {
                this.minlength = 8;
                if (!this.$.input.validate()) return false;
                var index = this.blacklist.indexOf(this.$.input.value);
                if (index != -1) {
                    this.errorMessage = "Password must not be a commonly used password.";
                    this.invalid = true;
                    return false; 
                }
                if (this.username.indexOf(this.$.input.value) != -1) {
                    this.errorMessage = "Password must not be part of the username.";
                    this.invalid = true;
                    return false; 
                }
                this.invalid = false;
                return true;
            }
        })
    </script>
</dom-module>
